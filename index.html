<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Dual Body</title>
    
</head>

<body>
    <header class="sticky row">
        <h4>Dual Body (control the robot with a short voice command and receive walking sound and visual feedbak)</h4> Commands: "Find Newton", "Find kitchen", "Find library" (Other interactive contents will be comming soon.)
    </header>
	  
<div id="listTalk" style="border: 1px solid #000; height: 40px; overflow-y: scroll; margin-bottom: 5px">
 <div id="result_text"></div>

</div>
<div id="getresult" style="color:green;"></div>
<div id="status">Click connect to TriStar then click start talking</div>
<div>
<p><input id="start_recognition" style="color: #000; background-color: #ff9b00cf;" type="submit" value="Start talking" /></p>
</div>

<div>
	<div style="float:left;width:20%;">
		<p>RoomID
			<input id="roomIdInput" type="text" value=""></input>
		</p>
		<p>
		ClientID
			<input id="clientIdInput" disabled type="text" value=""></input>
		</p>
		<p> Video coding
			<select id="video-codec" onChange="onChangeVideoCodec();">
				<option value="none">none</option>
				<option value="H264">H264</option>
				<option value="VP8">VP8</option>
				<option value="VP9">VP9</option>
			</select>
		</p>
		<button onclick="startConn();">Connect to TriStar</button>
		<button onclick="disconnect();">Disconnect with TriStar</button>
	    
		<p> recieved message </p>    
		<textarea style="height:200px;" id="messages" disabled type="text" value=""></textarea>
	
	</div>
	<div style="float:right; width:80%;">
		<video id="remote-video" autoplay playsinline controls style="width: 100%; height: 100%; border: 1px solid black;"></video>
	</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@open-ayame/ayame-web-sdk@2020.2.1/dist/ayame.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.7.0/qs.min.js"></script>

<script src="js/speech.js"></script>
<script src="js/main.js"></script>
<script type="text/javascript">
        const options = Ayame.defaultOptions;
        options.clientId = clientId ? clientId : options.clientId;
        if (signalingKey) {
          options.signalingKey = signalingKey;
        }
	const remoteVideo = document.querySelector('#remote-video');
        let conn;
        const disconnect = () => {
          if (conn) {
            conn.disconnect();
          }
        }
        let dataChannel = null;
        const label = 'dataChannel';
        const startConn = async () => {
	  options.video.codec = videoCodec;
          conn = Ayame.connection(signalingUrl, roomId, options, true);
	  const mediaStream = await navigator.mediaDevices.getUserMedia({audio: true, video: false})
	  const authnMetadata = {hoge: "fuga"};
          conn.on('open', ({authzMetadata}) => console.log(authzMetadata));
          conn.on('addstream', async (e) => {
            console.log(e.stream);
            remoteVideo.srcObject = e.stream;
          });
          await conn.connect(mediaStream, { authnMetadata });
	
          conn.on('open', async (e) => {
            dataChannel = await conn.createDataChannel(label);
            if (dataChannel) {
              dataChannel.onmessage = onMessage;
            }
          });
          conn.on('datachannel', (channel) => {
            if (!dataChannel) {
              dataChannel = channel;
              dataChannel.onmessage = onMessage;
            }
          });
          conn.on('disconnect', (e) => {
            console.log(e);
            dataChannel = null;
          });
          await conn.connect(null);
        };
        const sendSpData = () => {
          const data = document.querySelector("#sendDataInput").value;
          if (dataChannel && dataChannel.readyState === 'open') {
            dataChannel.send(data);
	    console.log(data);
          }
        };
        document.querySelector("#roomIdInput").value = roomId;
        document.querySelector("#clientIdInput").value = options.clientId;

        function onMessage(e) {
          const messages = document.querySelector("#messages").value;
          newMessages = messages ? (messages + '\n' + e.data) : e.data;
          document.querySelector("#messages").value = newMessages;
        }
      </script>
<script type="text/javascript">
    sendSpData( );
</script>


</body>

</html>
